IF NOT EXISTS (SELECT 1 FROM SchemaVersion WHERE VersionNumber = 3)
BEGIN
--Apply Partiotion
--DECLARE @StartDate DATE = '2025-01-01';
--DECLARE @Months INT = 480;  -- 40 years × 12 months
--DECLARE @i INT = 1;

--DECLARE @sql NVARCHAR(MAX) = '';

--WHILE @i <= @Months
--BEGIN
--    SET @sql = @sql + '''' + CONVERT(VARCHAR(10), DATEADD(MONTH, @i, @StartDate), 120) + '''';
--    IF @i < @Months SET @sql = @sql + ', ';
--    SET @i = @i + 1;
--END



-- Partition function for dates (monthly)
IF NOT EXISTS (SELECT * FROM sys.partition_functions WHERE name = 'PF_MonthlyDate')
BEGIN
    CREATE PARTITION FUNCTION PF_MonthlyDate(DATE)
    AS RANGE LEFT
    FOR VALUES 
    ('2025-02-01', '2025-03-01', '2025-04-01', '2025-05-01', '2025-06-01', '2025-07-01', '2025-08-01', '2025-09-01', '2025-10-01', '2025-11-01', '2025-12-01', '2026-01-01', '2026-02-01', '2026-03-01', '2026-04-01', '2026-05-01', '2026-06-01', '2026-07-01', '2026-08-01', '2026-09-01', '2026-10-01', '2026-11-01', '2026-12-01', '2027-01-01', '2027-02-01', '2027-03-01', '2027-04-01', '2027-05-01', '2027-06-01', '2027-07-01', '2027-08-01', '2027-09-01', '2027-10-01', '2027-11-01', '2027-12-01', '2028-01-01', '2028-02-01', '2028-03-01', '2028-04-01', '2028-05-01', '2028-06-01', '2028-07-01', '2028-08-01', '2028-09-01', '2028-10-01', '2028-11-01', '2028-12-01', '2029-01-01', '2029-02-01', '2029-03-01', '2029-04-01', '2029-05-01', '2029-06-01', '2029-07-01', '2029-08-01', '2029-09-01', '2029-10-01', '2029-11-01', '2029-12-01', '2030-01-01', '2030-02-01', '2030-03-01', '2030-04-01', '2030-05-01', '2030-06-01', '2030-07-01', '2030-08-01', '2030-09-01', '2030-10-01', '2030-11-01', '2030-12-01', '2031-01-01', '2031-02-01', '2031-03-01', '2031-04-01', '2031-05-01', '2031-06-01', '2031-07-01', '2031-08-01', '2031-09-01', '2031-10-01', '2031-11-01', '2031-12-01', '2032-01-01', '2032-02-01', '2032-03-01', '2032-04-01', '2032-05-01', '2032-06-01', '2032-07-01', '2032-08-01', '2032-09-01', '2032-10-01', '2032-11-01', '2032-12-01', '2033-01-01', '2033-02-01', '2033-03-01', '2033-04-01', '2033-05-01', '2033-06-01', '2033-07-01', '2033-08-01', '2033-09-01', '2033-10-01', '2033-11-01', '2033-12-01', '2034-01-01', '2034-02-01', '2034-03-01', '2034-04-01', '2034-05-01', '2034-06-01', '2034-07-01', '2034-08-01', '2034-09-01', '2034-10-01', '2034-11-01', '2034-12-01', '2035-01-01', '2035-02-01', '2035-03-01', '2035-04-01', '2035-05-01', '2035-06-01', '2035-07-01', '2035-08-01', '2035-09-01', '2035-10-01', '2035-11-01', '2035-12-01', '2036-01-01', '2036-02-01', '2036-03-01', '2036-04-01', '2036-05-01', '2036-06-01', '2036-07-01', '2036-08-01', '2036-09-01', '2036-10-01', '2036-11-01', '2036-12-01', '2037-01-01', '2037-02-01', '2037-03-01', '2037-04-01', '2037-05-01', '2037-06-01', '2037-07-01', '2037-08-01', '2037-09-01', '2037-10-01', '2037-11-01', '2037-12-01', '2038-01-01', '2038-02-01', '2038-03-01', '2038-04-01', '2038-05-01', '2038-06-01', '2038-07-01', '2038-08-01', '2038-09-01', '2038-10-01', '2038-11-01', '2038-12-01', '2039-01-01', '2039-02-01', '2039-03-01', '2039-04-01', '2039-05-01', '2039-06-01', '2039-07-01', '2039-08-01', '2039-09-01', '2039-10-01', '2039-11-01', '2039-12-01', '2040-01-01', '2040-02-01', '2040-03-01', '2040-04-01', '2040-05-01', '2040-06-01', '2040-07-01', '2040-08-01', '2040-09-01', '2040-10-01', '2040-11-01', '2040-12-01', '2041-01-01', '2041-02-01', '2041-03-01', '2041-04-01', '2041-05-01', '2041-06-01', '2041-07-01', '2041-08-01', '2041-09-01', '2041-10-01', '2041-11-01', '2041-12-01', '2042-01-01', '2042-02-01', '2042-03-01', '2042-04-01', '2042-05-01', '2042-06-01', '2042-07-01', '2042-08-01', '2042-09-01', '2042-10-01', '2042-11-01', '2042-12-01', '2043-01-01', '2043-02-01', '2043-03-01', '2043-04-01', '2043-05-01', '2043-06-01', '2043-07-01', '2043-08-01', '2043-09-01', '2043-10-01', '2043-11-01', '2043-12-01', '2044-01-01', '2044-02-01', '2044-03-01', '2044-04-01', '2044-05-01', '2044-06-01', '2044-07-01', '2044-08-01', '2044-09-01', '2044-10-01', '2044-11-01', '2044-12-01', '2045-01-01', '2045-02-01', '2045-03-01', '2045-04-01', '2045-05-01', '2045-06-01', '2045-07-01', '2045-08-01', '2045-09-01', '2045-10-01', '2045-11-01', '2045-12-01', '2046-01-01', '2046-02-01', '2046-03-01', '2046-04-01', '2046-05-01', '2046-06-01', '2046-07-01', '2046-08-01', '2046-09-01', '2046-10-01', '2046-11-01', '2046-12-01', '2047-01-01', '2047-02-01', '2047-03-01', '2047-04-01', '2047-05-01', '2047-06-01', '2047-07-01', '2047-08-01', '2047-09-01', '2047-10-01', '2047-11-01', '2047-12-01', '2048-01-01', '2048-02-01', '2048-03-01', '2048-04-01', '2048-05-01', '2048-06-01', '2048-07-01', '2048-08-01', '2048-09-01', '2048-10-01', '2048-11-01', '2048-12-01', '2049-01-01', '2049-02-01', '2049-03-01', '2049-04-01', '2049-05-01', '2049-06-01', '2049-07-01', '2049-08-01', '2049-09-01', '2049-10-01', '2049-11-01', '2049-12-01', '2050-01-01', '2050-02-01', '2050-03-01', '2050-04-01', '2050-05-01', '2050-06-01', '2050-07-01', '2050-08-01', '2050-09-01', '2050-10-01', '2050-11-01', '2050-12-01', '2051-01-01', '2051-02-01', '2051-03-01', '2051-04-01', '2051-05-01', '2051-06-01', '2051-07-01', '2051-08-01', '2051-09-01', '2051-10-01', '2051-11-01', '2051-12-01', '2052-01-01', '2052-02-01', '2052-03-01', '2052-04-01', '2052-05-01', '2052-06-01', '2052-07-01', '2052-08-01', '2052-09-01', '2052-10-01', '2052-11-01', '2052-12-01', '2053-01-01', '2053-02-01', '2053-03-01', '2053-04-01', '2053-05-01', '2053-06-01', '2053-07-01', '2053-08-01', '2053-09-01', '2053-10-01', '2053-11-01', '2053-12-01', '2054-01-01', '2054-02-01', '2054-03-01', '2054-04-01', '2054-05-01', '2054-06-01', '2054-07-01', '2054-08-01', '2054-09-01', '2054-10-01', '2054-11-01', '2054-12-01', '2055-01-01', '2055-02-01', '2055-03-01', '2055-04-01', '2055-05-01', '2055-06-01', '2055-07-01', '2055-08-01', '2055-09-01', '2055-10-01', '2055-11-01', '2055-12-01', '2056-01-01', '2056-02-01', '2056-03-01', '2056-04-01', '2056-05-01', '2056-06-01', '2056-07-01', '2056-08-01', '2056-09-01', '2056-10-01', '2056-11-01', '2056-12-01', '2057-01-01', '2057-02-01', '2057-03-01', '2057-04-01', '2057-05-01', '2057-06-01', '2057-07-01', '2057-08-01', '2057-09-01', '2057-10-01', '2057-11-01', '2057-12-01', '2058-01-01', '2058-02-01', '2058-03-01', '2058-04-01', '2058-05-01', '2058-06-01', '2058-07-01', '2058-08-01', '2058-09-01', '2058-10-01', '2058-11-01', '2058-12-01', '2059-01-01', '2059-02-01', '2059-03-01', '2059-04-01', '2059-05-01', '2059-06-01', '2059-07-01', '2059-08-01', '2059-09-01', '2059-10-01', '2059-11-01', '2059-12-01', '2060-01-01', '2060-02-01', '2060-03-01', '2060-04-01', '2060-05-01', '2060-06-01', '2060-07-01', '2060-08-01', '2060-09-01', '2060-10-01', '2060-11-01', '2060-12-01', '2061-01-01', '2061-02-01', '2061-03-01', '2061-04-01', '2061-05-01', '2061-06-01', '2061-07-01', '2061-08-01', '2061-09-01', '2061-10-01', '2061-11-01', '2061-12-01', '2062-01-01', '2062-02-01', '2062-03-01', '2062-04-01', '2062-05-01', '2062-06-01', '2062-07-01', '2062-08-01', '2062-09-01', '2062-10-01', '2062-11-01', '2062-12-01', '2063-01-01', '2063-02-01', '2063-03-01', '2063-04-01', '2063-05-01', '2063-06-01', '2063-07-01', '2063-08-01', '2063-09-01', '2063-10-01', '2063-11-01', '2063-12-01', '2064-01-01', '2064-02-01', '2064-03-01', '2064-04-01', '2064-05-01', '2064-06-01', '2064-07-01', '2064-08-01', '2064-09-01', '2064-10-01', '2064-11-01', '2064-12-01', '2065-01-01');
END

IF NOT EXISTS (SELECT * FROM sys.partition_schemes WHERE name = 'PS_MonthlyDate')
BEGIN
    CREATE PARTITION SCHEME PS_MonthlyDate
    AS PARTITION PF_MonthlyDate
    ALL TO ([PRIMARY]);
END

IF NOT EXISTS (
    SELECT 1 
    FROM sys.indexes 
    WHERE name = 'IX_EmployeeRoster_RosterDate_EmployeeId'
      AND object_id = OBJECT_ID('EmployeeRoster')
)
BEGIN
    CREATE NONCLUSTERED INDEX IX_EmployeeRoster_RosterDate_EmployeeId
    ON EmployeeRoster(EmployeeId, RosterDate)  -- columns to index
    ON PS_MonthlyDate(RosterDate);             -- partitioned on RosterDate
END


IF NOT EXISTS (
    SELECT 1 
    FROM sys.indexes 
    WHERE name = 'IX_EmployeeAttendance_EmployeeId_AttendanceDate'
      AND object_id = OBJECT_ID('EmployeeAttendance')
)
BEGIN
    CREATE NONCLUSTERED INDEX IX_EmployeeAttendance_EmployeeId_AttendanceDate
    ON EmployeeAttendance(EmployeeId, AttendanceDate)
    ON PS_MonthlyDate(AttendanceDate);
END

IF NOT EXISTS (
    SELECT 1 
    FROM sys.indexes 
    WHERE name = 'IX_EmployeeAttendanceLog_EmployeeId_AttendanceDate'
      AND object_id = OBJECT_ID('EmployeeAttendanceLog')
)
BEGIN
    CREATE NONCLUSTERED INDEX IX_EmployeeAttendanceLog_EmployeeId_AttendanceDate
    ON EmployeeAttendanceLog(EmployeeId, AttendanceDate)
    ON PS_MonthlyDate(AttendanceDate);
END
 -------------------------------
    -- Insert Schema Version
    -------------------------------
    INSERT INTO SchemaVersion (VersionNumber, AppliedOn)
    VALUES (3, GETDATE());
END